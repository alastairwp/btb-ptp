{% load static %}

<html>
   <head>
<link href="{% static 'css/stylenew.css' %}" rel="stylesheet">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

   </head>
   <body>

   <div id="container">

       <div class="logout_button">
            <a href="logout" class="btn btn-primary">Logout</a>
       </div>
        {#<iframe ></iframe>#}
       {#<iframe src="chart.php?id=<?php echo $id; ?>"></iframe>#}
      <div id="chart"></div>
       <form  action="/login" autocomplete="on" method="post">

           <input id="question_id" value="{{ question_id }}" type="hidden">

           <div id="question">{{ question.question_name }}</div>

           <div class="row  col-sm-12 all_data">
               <div class="cell newcell checkbox" data-type="1"></div>
               <div class="cell newcell checkbox" data-type="2"></div>
               <div class="cell newcell checkbox" data-type="3"></div>
               <div class="cell newcell checkbox" data-type="4"></div>
               <div class="cell newcell checkbox" data-type="5"></div>
               <div class="cell newcell checkbox" data-type="6"></div>
               <div class="cell newcell checkbox" data-type="7"></div>
               <div class="cell newcell checkbox" data-type="8"></div>
               <div class="cell newcell checkbox" data-type="9"></div>
           </div>
           <div class="row  col-sm-12 all_data">
               <div class="cell">1</div>
               <div class="cell">2</div>
               <div class="cell">3</div>
               <div class="cell">4</div>
               <div class="cell">5</div>
               <div class="cell">6</div>
               <div class="cell">7</div>
               <div class="cell">8</div>
               <div class="cell">9</div>
           </div>

           <input id="next_id" value="{{ next_id.id }}" type="hidden">
           {% if next_id.id != null  %}
           <a href="/?id_data={{ next_id.id }}" class="btn btn-info">Next</a>
           {% endif %}

       </form>
   </div>

   {#<button id="next" disabled>NEXT</button>#}


   <script type="text/javascript">


       setInterval(function () {
               var url = 'get_chart_data';
               var question_id = $('#question_id').val();

               $.ajax({
                   url: url,
                   type: "POST",
                   data:{question_id:question_id},
                   success: function (result) {
                       var xvalue = new Array();
                       var votes = [1,2,3,4,5,6,7,8,9];
                       result.alldata.forEach(function (item,key) {
                            var x = item.fields.value
                           xvalue.push(x);
                           console.log(x);
                       });

                       var cheknewarray = new Array();
                       votes.forEach(function (item,key) {
                           var i =0;
                           xvalue.forEach(function (itemdata,keydata) {
                              if(itemdata==item){
                                i = i+1;
                              }
                           })

                           cheknewarray.push(i);
                       })

                        drawChart(votes,cheknewarray)
                   }
               });
       },3000);

       function drawChart(x,y) {

          // var datas = JSON.parse(localStorage.getItem('datas'));
           var trace = {
               x: x,
               y: y,
               type: 'bar',
               marker: {
                   color: ['#2d86c8', '#51d761', '#fdc736', '#fb8d2c', '#cc22e3', '#4c4fd0', '#f93331', '#7fb9fc', '#6edb8b']
               },
           };
           var layout = {
               autosize: false,
               width: window.innerWidth - 600,
               height: window.innerHeight - 300,
               xaxis: {
                   tickangle: 0,
                   showticklabels: true,
                   type: 'category',
                   title: 'Vote score'
               },
               yaxis: {
                   tickangle: 0,
                   showticklabels: true,
                   title: 'Count'
               },
               margin: {
                   l: 75,
                   r: 0,
                   b: 50,
                   t: 50,
                   pad: 0
               },
               font: {
                   family: 'Raleway, sans-serif',
                   size: 20
               },
               showlegend: false
           };

           Plotly.newPlot('chart', [trace], layout, {
               scrollZoom: false,
               displayModeBar: false
           });
       }


       $('docuement').ready(function () {

           $('.newcell').click(function () {

               var valueget = $(this).attr('data-type');
               var question_id = $('#question_id').val();
               var next_iddata  = $('#next_id').val();
               var question_comment = $('#UserComment').val();
               var url = 'save_vote_data';
               $.ajax({
                   url: url,
                   type: "POST",
                   data: {question_id:question_id,value:valueget,question_comment:question_comment},
                   // success: function (result) {
                   //    if(result.resultdata==1){
                   //        if(next_iddata!=''){
                   //         window.location.href = '?id_data='+next_iddata;
                   //       }
                   //    }
                   //}
               });
           });
       });

       function getCookie(name) {
           var cookieValue = null;
           if (document.cookie && document.cookie !== '') {
               var cookies = document.cookie.split(';');
               for (var i = 0; i < cookies.length; i++) {
                   var cookie = cookies[i].trim();
                   // Does this cookie string begin with the name we want?
                   if (cookie.substring(0, name.length + 1) === (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
       }

       var csrftoken = getCookie('csrftoken');


       function csrfSafeMethod(method) {
           // these HTTP methods do not require CSRF protection
           return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
       }

       $.ajaxSetup({
           beforeSend: function (xhr, settings) {
               if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                   xhr.setRequestHeader("X-CSRFToken", csrftoken);
               }
           }
       });

   </script>



   </body>


</html>



